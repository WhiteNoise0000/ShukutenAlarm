# Androidアラーム×祝日×天気アプリ 仕様書（個人利用・非公開）v1.0

最終更新: 2025-09-07 / Asia/Tokyo

---

## 0. 背景と目的

- Pixel を想定した「個人利用向け」Android アプリ。
- 目覚まし（アラーム）を主機能とし、日本の祝日と当日の天気で鳴動ロジックやサウンドを切り替える。
- 配布は Play ストア想定外（開発・検証用、ADB サイドロード）。
- データは端末内完結（祝日データは同梱、天気は Open‑Meteo から取得・キー不要）。

---

## 1. スコープ

- 祝日・天気に応じてアラーム動作やサウンドを切り替え。
- 祝日判定はオフライン優先（同梱データ）。
- 天気は Open‑Meteo の `/v1/jma` を利用（キー不要）。
- 位置情報は大まかな位置（COARSE）で十分。GPS は不要。
- 正確な時刻で鳴ることを最優先（AlarmManager の exact 系 API とフルスクリーン通知）。

非スコープ（v1では未対応）

- ストア公開・課金、解析 SDK、クラウド保存。
- 複数端末同期、バックアップ/復元のUI（内部的に最小限のバックアップ設定は保持）。

---

## 2. ターゲット/互換

- 対象OS: Android 14+（minSdk=34）、target/compileSdk は最新に追随。
- 端末: Pixel 6 以降で検証（他端末はベストエフォート）。

---

## 3. ユースケース

1. 平日 7:00 にアラーム。祝日は 8:00 に遅らせる（DELAY）またはスキップ（SKIP）。
2. 雨予報なら起床前 45 分（設定可）に天気を先読みし、対応サウンドに切り替える。
3. 取得失敗時でも既定時刻にデフォルト音で確実に鳴動。

---

## 4. 非機能要件

- 信頼性: Doze/省電力下でも時刻通りに鳴動（`setAlarmClock`/FSI）。
- オフライン耐性: 祝日データは同梱（YAML）、天気はキャッシュ/フォールバックあり。
- セキュリティ/プライバシー: 端末内完結（位置・設定はローカル保存）。
- 性能/電池: 天気取得は 1 日 1 回相当、またはアラーム前の先読みのみ。

---

## 5. 概要

- 言語/UI: Kotlin, Jetpack Compose, Material3
- データ永続化: DataStore
- バックグラウンド処理: AlarmManager（アラーム鳴動）/ WorkManager（天気先読み・祝日更新）
- ネットワーク通信: Retrofit

---

## 6. アーキテクチャ概要

- MVVM + Repository 構成。シングルアクティビティ + Compose Navigation。

---

## 7. 主要フロー

1. アラーム登録: UIからアラームを登録。指定時刻に正確に鳴動するよう設定される。
2. 事前天気取得: アラーム時刻の N 分前（既定 45）に天気を先読みする（ネットワーク接続時）。
3. 鳴動: アラーム時刻になると、フルスクリーン通知でアラーム画面が前面に表示され、設定されたサウンドが再生される。
4. 音源選択: 祝日か否かは鳴動可否（SKIP/DELAY/SAME）にのみ影響。サウンドは天気カテゴリのマッピングを使用し、未設定時はデフォルトにフォールバックする（祝日優先ロジックなし）。

---

## 8. 権限/ポリシー設計

- 正確なアラーム:
  - 個人配布前提のため `USE_EXACT_ALARM` を宣言。
  - 公開する場合は `SCHEDULE_EXACT_ALARM` と許可誘導UI（`ACTION_REQUEST_SCHEDULE_EXACT_ALARM`）を検討。
- 通知: Android 13+ で `POST_NOTIFICATIONS`（初回に説明）。
- 位置情報: `ACCESS_COARSE_LOCATION` を使用（高精度は不要）。
- フルスクリーン通知: `USE_FULL_SCREEN_INTENT`（アラーム用途）。
- 起動完了: `RECEIVE_BOOT_COMPLETED`（端末起動時にアラームを再設定するため）。
- インターネット: `INTERNET`（天気情報取得のため）。
- バイブレーション: `VIBRATE`（アラーム時のバイブレーションのため）。

---

## 9. 天気カテゴリ（WMO→アプリ）

- WMO `weathercode` をアプリ内カテゴリへマッピング。
  - Clear: `0`
  - Cloudy: `1..3`
  - Rain/Drizzle: `51..57, 61..65, 80..82`
  - Snow: `71..75, 85, 86`
  - Thunder: `95..99` は雨として扱う
  - その他: Cloudyにフォールバック

---

## 10. 位置取得/キャッシュ

- **天気予報の取得元**:
  - 「都市名で指定」または「現在地で指定」を選択可能。
  - **都市名で指定**: 都市名を入力し、検索結果から選択することで緯度経度を設定。選択された都市名が表示される。
  - **現在地で指定**: トグルをONにすると、位置情報権限が許可されていれば端末の現在地を動的に取得し、アラーム直前の天気先読み時に利用する。
  - 位置情報は「天気予報取得のため」に利用されることを明示。
- **天気取得のテスト**:
  - 現在の設定に基づき、天気情報を即時取得し、結果を表示する機能。
- **キャッシュ**:
  - 天気の直近取得結果は DataStore に保存（当日限り想定）。
- **緯度経度表示**:
  - UI簡素化のため、緯度経度の直接表示は行わない。

---

## 11. データモデル抜粋

- `WeatherCategory`: 天気の種類を表すカテゴリ（`CLEAR`, `CLOUDY`, `RAIN`, `SNOW`）。
- `AlarmSpec`: アラームの設定情報。
  - `id`: アラームを一意に識別するID。
  - `name`: アラーム名（任意）。
  - `time`: アラーム時刻。
  - `daysOfWeek`: アラームが鳴動する曜日。
  - `holidayPolicy`: 祝日の鳴動ポリシー（`SKIP`, `DELAY`, `SAME`）。
  - `volumeMode`: 音量設定モード（`SYSTEM`, `CUSTOM`）。
  - `volumePercent`: 個別音量（0-100、`CUSTOM`時のみ有効）。
  - `vibrate`: バイブレーションの有無。
  - `respectSilentMode`: マナー/サイレントモードの尊重。
  - `holidayOnly`: 祝日のみ鳴動するかどうか。
  - `prefetchMinutes`: 天気情報を先読みする時間（分）。
  - `soundMapping`: 天気カテゴリごとのサウンドURI。
  - `holidaySound`: デフォルトサウンド（天気別が未設定時のフォールバック）。
  - `enabled`: アラームの有効/無効。
- `HolidayPolicy`: 祝日の鳴動ポリシー（`SKIP`, `DELAY`, `SAME`）。

---

## 12. 画面（Compose）

- ホーム: アラーム一覧（ON/OFF、時刻、曜日、祝日ポリシー、設定概要）。FABで追加。
- 編集: 時刻、曜日、祝日ポリシー、天気別サウンド（晴/曇/雨/雪）。
- 設定: 位置設定（手動/現在地）、通知と正確アラームの説明、祝日データ更新、デバッグ（直近天気ログ）。
- 鳴動: フルスクリーン通知で前面表示。スヌーズ/停止、現在の天気ラベル、祝日ラベル表示。

---

## 13. Open-Meteo API インタフェース

- エンドポイント: `/v1/jma`
- クエリパラメータ:
  - `latitude`: 緯度 (Double)
  - `longitude`: 経度 (Double)
  - `hourly`: 取得する時間ごとのデータ（例: `weathercode,precipitation_probability`）
  - `timezone`: タイムゾーン（例: `Asia/Tokyo`）

---

## 14. Geocoding API インタフェース

- ベースURL: `https://geocoding-api.open-meteo.com/`
- エンドポイント: `/v1/search`
- クエリパラメータ:
  - `name`: 検索する都市名 (String)
  - `language`: 言語（デフォルト: `ja`）
  - `count`: 取得する結果の数（デフォルト: `8`）

---

## 15. 祝日データ

- `assets/holidays.yml` に祝日データを同梱。
- アプリ起動時に同梱データを読み込み、必要に応じてオンラインで最新の祝日データを更新し、内部キャッシュとして利用する。
- 祝日判定は、このデータに基づいて行われる。

---

## 16. 通知/鳴動

- 通知チャンネル: `ALARM`（重要度高）。
- アラーム時刻になると、フルスクリーン通知によりアラーム画面が前面に表示される。
- 音声再生はアラーム用途のオーディオ属性を使用。
- サウンドの再生に失敗した場合は、システムのデフォルトアラーム音にフォールバックする。

---

## 17. 受け入れ基準（例）

- 祝日サンプル: 成人の日に `HolidayPolicy=DELAY` で設定分だけ後ろ倒しになる。
- 雨予報の日に雨用サウンドへ切り替わる（先読み成功時）。
- 先読み失敗時でも既定時刻にデフォルト音で鳴る。
- ロック画面中にフルスクリーン通知で鳴動画面が前面化する。

---

## 18. 既知の論点/メモ

- `USE_EXACT_ALARM` は個人配布では便利だが、Play 公開時はポリシー要件あり。公開予定が出たら `SCHEDULE_EXACT_ALARM` に切替と許可誘導UIを要検討。
- フルスクリーン通知は Android 14+ の制限により「通話/アラーム」に限定。乱用不可。
- DND 中の挙動はベンダー差があるため、実機での検証を推奨。

---

## 19. ホームウィジェット

- 提供ウィジェット: 2x1「次回アラーム」ウィジェット（ホーム画面）。
- 表示仕様:
  - 時刻: 「H:mm」（大きめ/太字）。
  - 日付: 「M/d(E)」。祝日の場合は末尾に「 [祝]」を付与。
  - タイトル: 「次回アラーム」。
- 操作仕様:
  - 本体タップ: アプリ起動（`MainActivity`）。
  - タイトルタップ: ウィジェット内容を手動更新。
  - 「スキップ」ボタン: 直近のアラームを1回だけスキップ（現在の登録をキャンセル → 設定に基づき次回以降を再スケジュール）。
- ロジック整合:
  - 次回候補計算は祝日ポリシー（SKIP/DELAY/SAME）、`holidayOnly`、`delayMinutes` に準拠して行われる。
  - スキップ動作は現在のアラームをキャンセルし、設定に基づき次回以降のアラームを再スケジュールすることで実現される。
- デザイン:
  - 角丸カード＋ダーク系グラデーション背景、半透明の角丸ボタン（モダン・シンプル）。
- 更新ポリシー:
  - 自動更新なし。ユーザー操作（スキップ/タイトルタップ）時に明示更新。
  - 将来拡張: アラーム設定変更時やシステムからの次回アラーム変更通知受信での更新を検討。

---

## 20. 今後拡張

- バックアップ/リストア（`DocumentFile` 経由でJSON書出し）。

以上。
